#!/usr/bin/env rc

git rev-parse --git-dir >/dev/null >[2=1] || exit 0

fn commit {
	msg=`{prompt 'message' $1}
	@ = $*(3-)
	if (~ $"msg '') @ = $@ --no-edit
	if not @ = $@ -m $"msg
	git commit $@ && push $2
}

fn push {
	reply=`{choice 'push?' 'y,n,!' $1}
	@ = (); ~ $reply '!' && @ = --force
	~ $reply y Y '!' && git push origin $@
}

fn sync {
	if (! git diff --cached --quiet) {
		step -ab sync
		reply=`{choice 'commit?' 'Y,n,a,r,u,v,x' y}
		switch ($reply) {
		case y Y
			commit Fixups y
		case a A
			commit '' n --amend
		case r R
			clear
			exec v
		case u U
			git reset -p
			sync
		case x X
			git gui
			sync
		case v V
			gitk
			sync
		}
	}
}

step -b status
git status -s

new=`{git ls-files --others --exclude-standard}
if (! ~ $#new 0) {
	echo
	if (confirm 'add '$#new' new?')
		for (f in $new)
			if (confirm $f'?')
				git add $f
}

if (! git diff --quiet) {
	step -ab stage
	git add -p
}

sync

true
