#!/usr/bin/env rc

git rev-parse --git-dir >/dev/null >[2=1] || exit 0

fn sync {
	if (! git diff --cached --quiet) {
		step -ab sync
		reply=`{choice 'commit?' 'Y,n,r,u,v,x' y}
		switch ($reply) {
		case y Y
			msg=`{prompt 'message' Fixups}
			git commit -m $"msg &&
			if (confirm 'push?' y)
				git push origin
		case r R
			clear
			exec v
		case u U
			git reset -p
			sync
		case x X
			git gui
			sync
		case v V
			gitk
			sync
		}
	}
}

step -b status
git status -s

new=`{git ls-files --others --exclude-standard}
if (! ~ $#new 0) {
	echo
	if (confirm 'add '$#new' new?')
		for (f in $new)
			if (confirm $f'?')
				git add $f
}

if (! git diff --quiet) {
	step -ab stage
	git add -p
}

sync

true
