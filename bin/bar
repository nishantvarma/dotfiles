#!/usr/bin/env rc

fn desktops {
	output='Desktop '
	desktops=`{bspc query -D --names}
	focused=`{bspc query -D -d focused --names}
	occupied=`{bspc query -D -d .occupied --names}
	for (desktop in $desktops) {
		single='%{A:bspc desktop -f '$desktop':} '$desktop' %{A}'
		if (~ $desktop $focused) single=`{hl $single}
		if not if (echo $occupied | grep -q $desktop) single=`{mark $single}
		output=$"output$"single
	}
	echo $"output
}

fn bat {
	cat /sys/class/power_supply/BAT0/capacity
}

fn cpu {
	top -bn1 | grep 'Cpu(s)' | awk '{printf "%.1f", $2 + $4}'
}

fn mem {
	top -bn1 | grep 'MiB Mem' | awk '{printf "%.1f", $8 / 1024}'
}

fn hl {
	echo '%{F#000000}%{B#ffffff}'$1'%{F-}%{B-}'
}

fn mark {
	echo '%{F#ffffff}%{B#262626}'$1'%{F-}%{B-}'
}

fn status {
	while (true) {
		desktops=`{desktops}
		date=`{date}
		cpu=`{cpu}
		mem=`{mem}
		bat=`{bat}
		echo '%{l}'$"desktops'%{c}'$"date'%{r}Cpu '$"cpu' | Mem '$"mem' | Bat '$"bat
		sleep 1
	}
}

fn process {
	while (true) eval `{read}
}

status | lemonbar -B '#121212' -F '#ffffff' -p | process
