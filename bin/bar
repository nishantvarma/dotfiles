#!/usr/bin/env dash

bat()
{
	cat /sys/class/power_supply/BAT0/capacity
}

cpu()
{
	top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}'
}

mem()
{
	top -bn1 | grep "MiB Mem" | awk '{printf "%.1f\n", $8 / 1024}'
}

hl()
{
	echo "%{F#000000}%{B#ffffff}$1%{F-}%{B-}"
}

desktops()
{
	output=""
	desktops=$(bspc query -D --names)
	focused=$(bspc query -D -d focused --names)
	for desktop in $desktops; do
		single="%{A:bspc desktop -f $desktop:} $desktop %{A}"
		if [ "$desktop" = "$focused" ]; then
			single=$(hl "$single")
		fi
		output="$output$single"
	done
	echo $output
}

status()
{
	while true; do
		echo "%{l}$(desktops) %{c}$(date '+%H:%M:%S %b %d %a %Y') %{r}Cpu $(cpu) | Mem $(mem) | Bat $(bat)"
		sleep 1
	done
}

status |
lemonbar -B "#121212" -F "#ffffff" -p |
while true; do
	read -r line
	eval "$line"
done
